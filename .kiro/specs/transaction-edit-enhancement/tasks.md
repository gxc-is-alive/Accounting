# 实现计划：交易编辑增强

## 概述

本实现计划将交易编辑增强功能分解为可执行的编码任务。实现顺序遵循渐进式原则：先实现搜索功能（低风险），再实现账户修改功能（高风险），最后进行集成测试。

## 任务列表

- [x] 1. 为 AccountCardSelector 组件添加搜索功能
  - [x] 1.1 在组件中添加搜索框 UI
    - 在 `section-title` 和 `account-grid` 之间插入 `el-input` 搜索框
    - 添加搜索图标和清空按钮
    - 设置合适的 placeholder："搜索账户..."
    - _需求：2.1_
  - [x] 1.2 实现搜索过滤逻辑
    - 添加 `searchQuery` ref 状态
    - 创建 `filteredAccounts` computed 属性
    - 实现不区分大小写的部分匹配算法
    - 修改 `displayedAccounts` 使用 `filteredAccounts` 而非 `sortedAccounts`
    - _需求：2.2, 2.3_
  - [x] 1.3 添加空搜索结果提示
    - 当 `filteredAccounts.length === 0` 且 `searchQuery` 不为空时显示提示
    - 提示文本："未找到匹配的账户"
    - _需求：2.4_
  - [x] 1.4 编写 AccountCardSelector 搜索功能的单元测试
    - 测试搜索框渲染
    - 测试空搜索结果提示
    - 测试清空搜索恢复列表
    - 测试选择事件触发
    - _需求：2.1, 2.4, 2.5, 2.6_
  - [x] 1.5 编写账户搜索过滤的属性测试
    - **属性 2：账户搜索过滤的正确性**
    - **验证：需求 2.2, 2.3, 2.5**
    - 使用 fast-check 生成随机账户列表和搜索关键词
    - 验证过滤结果只包含匹配项
    - 验证排序顺序保持不变
    - 验证空关键词返回完整列表
    - 最少 100 次迭代

- [x] 2. 为 CategoryCardSelector 组件添加搜索功能
  - [x] 2.1 在组件中添加搜索框 UI
    - 在 `section-title` 和 `category-grid` 之间插入 `el-input` 搜索框
    - 添加搜索图标和清空按钮
    - 设置合适的 placeholder："搜索分类..."
    - _需求：3.1_
  - [x] 2.2 实现搜索过滤逻辑
    - 添加 `searchQuery` ref 状态
    - 创建 `filteredCategories` computed 属性
    - 实现不区分大小写的部分匹配算法
    - 修改 `displayedCategories` 使用 `filteredCategories` 而非 `sortedCategories`
    - _需求：3.2, 3.3_
  - [x] 2.3 添加空搜索结果提示
    - 当 `filteredCategories.length === 0` 且 `searchQuery` 不为空时显示提示
    - 提示文本："未找到匹配的分类"
    - _需求：3.4_
  - [x] 2.4 编写 CategoryCardSelector 搜索功能的单元测试
    - 测试搜索框渲染
    - 测试空搜索结果提示
    - 测试清空搜索恢复列表
    - 测试选择事件触发
    - _需求：3.1, 3.4, 3.5, 3.6_
  - [x] 2.5 编写分类搜索过滤的属性测试
    - **属性 3：分类搜索过滤的正确性**
    - **验证：需求 3.2, 3.3, 3.5**
    - 使用 fast-check 生成随机分类列表和搜索关键词
    - 验证过滤结果只包含匹配项
    - 验证排序顺序保持不变
    - 验证空关键词返回完整列表
    - 最少 100 次迭代

- [x] 3. 检查点 - 确保搜索功能正常工作
  - 确保所有测试通过，如有问题请向用户提问

- [x] 4. 在 TransactionList 编辑对话框中添加账户选择器
  - [x] 4.1 导入 AccountCardSelector 组件和 accountStore
    - 在 `TransactionList.vue` 中导入 `AccountCardSelector` 组件
    - 导入 `useAccountStore` 并获取账户列表
    - _需求：1.1_
  - [x] 4.2 修改 editForm 数据结构
    - 添加 `accountId: number | null` 字段
    - 添加 `originalAccountId` ref 用于记录原始账户（余额调整需要）
    - _需求：1.2_
  - [x] 4.3 在编辑对话框中添加账户选择器 UI
    - 在分类选择器和日期选择器之间添加 `el-form-item`
    - label 设置为 "账户"
    - 使用 `AccountCardSelector` 组件
    - 绑定 `v-model="editForm.accountId"`
    - 传入 `:accounts="accounts"`
    - _需求：1.1_
  - [x] 4.4 修改 handleEdit 函数
    - 在打开编辑对话框时，设置 `editForm.accountId = row.accountId`
    - 设置 `originalAccountId.value = row.accountId`
    - 确保账户选择器预选当前账户
    - _需求：1.2_
  - [x] 4.5 编写编辑对话框账户选择器的单元测试
    - 测试账户选择器渲染
    - 测试表单数据绑定
    - 测试账户变更时表单更新
    - _需求：1.1, 1.2_

- [x] 5. 修改后端 API 支持账户变更
  - [x] 5.1 更新 TransactionController.update 方法
    - 在 `backend/src/controllers/transaction.controller.ts` 中修改 `update` 方法
    - 添加对 `accountId` 字段的处理
    - 检查 `accountId` 是否变更
    - 如果变更，调用账户余额调整逻辑
    - _需求：1.3, 1.4_
  - [x] 5.2 实现账户余额调整逻辑
    - 创建 `adjustAccountBalanceOnUpdate` 辅助函数
    - 使用 Sequelize 事务包裹所有操作
    - 获取原交易记录（加锁）
    - 根据交易类型调整原账户余额
    - 根据交易类型调整新账户余额
    - 更新交易的 accountId
    - _需求：1.4, 1.5, 1.6_
  - [x] 5.3 添加错误处理
    - 交易不存在：返回 404
    - 账户不存在：返回 404
    - 权限不足：返回 403
    - 事务失败：返回 500 并回滚
    - 并发冲突：返回 409
    - _需求：4.1_
  - [x] 5.4 编写账户变更 API 的单元测试
    - 测试成功更新账户
    - 测试交易不存在
    - 测试账户不存在
    - 测试权限验证
    - 测试支出类型余额调整
    - 测试收入类型余额调整
    - 测试退款类型余额调整
    - _需求：1.3, 1.4, 1.5, 1.6_
  - [x] 5.5 编写账户余额调整的属性测试
    - **属性 1：账户变更时余额调整的正确性**
    - **验证：需求 1.4, 1.5, 1.6**
    - 使用 fast-check 生成随机交易和账户
    - 验证余额调整的守恒定律（两个账户余额变化总和为零）
    - 验证支出类型的余额调整规则
    - 验证收入类型的余额调整规则
    - 验证退款类型的余额调整规则
    - 最少 100 次迭代
  - [x] 5.6 编写交易更新失败回滚的属性测试
    - **属性 5：交易更新失败时的回滚**
    - **验证：需求 4.1**
    - 模拟随机失败场景（网络错误、验证失败等）
    - 验证余额回滚的正确性
    - 验证交易记录保持不变
    - 最少 100 次迭代

- [x] 6. 修改前端提交逻辑
  - [x] 6.1 更新 submitEdit 函数
    - 在 `TransactionList.vue` 的 `submitEdit` 函数中
    - 将 `accountId` 添加到更新请求的数据中
    - 处理账户变更的成功和失败情况
    - 显示合适的成功/错误提示
    - _需求：1.3_
  - [x] 6.2 添加前端错误处理
    - 账户列表为空时禁用保存按钮
    - 网络请求失败时显示错误提示
    - 保持对话框打开允许重试
    - _需求：错误处理_
  - [x] 6.3 编写前端提交逻辑的单元测试
    - 测试成功提交
    - 测试网络错误处理
    - 测试表单验证
    - _需求：1.3_

- [x] 7. 检查点 - 确保所有功能正常工作
  - 确保所有测试通过，如有问题请向用户提问

- [x] 8. 集成测试和优化
  - [x]\* 8.1 编写端到端集成测试
    - 测试完整流程：打开编辑对话框 → 修改账户 → 保存 → 验证余额
    - 测试搜索功能：使用搜索 → 选择账户 → 验证选择结果
    - 测试并发场景：模拟多用户同时修改
    - _需求：所有需求_
    - _注：核心功能已通过单元测试和属性测试充分验证_
  - [x] 8.2 编写搜索不影响选择功能的属性测试
    - **属性 4：搜索不影响选择功能**
    - **验证：需求 2.6, 3.6**
    - 生成随机搜索场景
    - 验证选择事件的正确性
    - 验证 v-model 更新
    - 最少 100 次迭代
  - [x]\* 8.3 编写编辑表单数据绑定的属性测试
    - **属性 6：编辑表单数据绑定的正确性**
    - **验证：需求 1.2, 1.3**
    - 生成随机交易数据
    - 验证表单数据的正确绑定
    - 验证账户预选的正确性
    - 最少 100 次迭代
    - _注：已通过 TransactionList 单元测试充分验证_
  - [x]\* 8.4 性能优化（可选）
    - 优化搜索过滤性能（大量数据场景）
    - 添加搜索防抖（如果需要）
    - 优化账户余额查询（添加索引）
    - _注：当前实现性能良好，暂不需要优化_

## 注意事项

- 每个任务都引用了具体的需求编号，确保可追溯性
- 检查点任务确保增量验证，及时发现问题
- 属性测试使用 fast-check 库，每个测试最少 100 次迭代
- 单元测试使用 Vitest（前端）和 Jest（后端）
- 所有测试任务都是必需的，确保从一开始就全面测试
